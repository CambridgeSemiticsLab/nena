{% extends 'nena.html' %}

{% block subtitle %}
    {% if search_term %}Replace {{dialect_features|length}} "{{search_term}}" entries for {% endif %}
    {% if with_without_unknown == 'with' %} Dialects with{% endif %}
    {% if with_without_unknown == 'without' %} Dialects without{% endif %}
    {% if with_without_unknown == 'unknown' %} Dialects with no record for{% endif %}
    {{ feature.fullheading }}&nbsp;{{ feature.name|safe }}
    {% if entry_filter %}matching "<span class="aramaic">{{entry_filter|safe}}</span>"{% endif %}
    {% if chosen_location_name %}in {{chosen_location_name}}{% endif %}
    {% if chosen_community_name %}in {{chosen_community_name}} communities{% endif %}
    {% if search_term %}?{% endif %}
{% endblock %}

{% block page_content %}
  <div class="campl-column12 clearfix" id="feature_detail">
  <div class="campl-content-container">

    <p>
      Of the {{num_dialects}} dialects
      <a href="{% url 'grammar:feature-detail' feature.id %}">{{num_with}} {{num_with|pluralize:'has,have'}} this feature</a>,
      <a href="{% url 'grammar:feature-detail' feature.id %}?is_absent=true">{{num_without}} {{num_without|pluralize:"doesn't,don't"}}</a>
      and
      <a href="{% url 'grammar:feature-detail' feature.id %}?is_unknown=true">{{num_unknown}} {{num_unknown|pluralize:'has,have'}} no current record</a>.
    </p>

    {% include 'dialects/_dialect_filter.html' %}
    <a href="?as_csv=1" class="button fr">
        ➥ CSV
    </a>
    <form id="table_form" action="{% url 'grammar:feature-map' feature.id %}?{{ request.GET.urlencode }}" method="POST">
    {% csrf_token %}
    <input class="button fr" type="submit" value="See map of this feature">
    <a id="add_to_group" class="button fr">
        Add to map group
    </a>
    <table class="checkable-rows campl-table campl-table-condensed campl-table-striped">
      {% for dialect_feature in dialect_features %}
      {% with dialect=dialect_feature.dialect entries=dialect_feature.entries %}
        <tr>
          <td>
            <input type="checkbox" class="chex row_select" name="checked_dialect_id" value="{{dialect.id}}">
            <input type="hidden" name="dialect_id" value="{{dialect.id}}">
            <input type="hidden" name="group_key" value="{{dialect_feature.group_key|default_if_none:0}}">
          </td>
          <td>
            <span class="map_group {{dialect_feature.group_key|yesno:"visible,"}}" title="map group">
              {{dialect_feature.group_key}}
            </span>
          </td>
          <td>
            <a href="{% url 'dialects:dialect-detail' dialect.id %}">{{ dialect.name }}</a>
          </td>
          <td>
          {% if dialect_feature.category %}
            {{dialect_feature.category}}<br>
          {% endif %}

          {% for entry in dialect_feature.entries.all %}
            <div>
              <span class="entry">{{ entry.entry }}</span>
              {% if entry.entry == search_term %}
                <span style="color:red;">&rarr; {{replacement}}</span>
              {% endif %}
              <a class="filter" title="filter entries like this" href="{% url 'grammar:feature-detail' feature.id %}?entry={{ entry.entry }}">
                <svg viewBox="0 0 80 90" focusable=false><path d="m 0,0 30,45 0,30 10,15 0,-45 30,-45 Z"></path></svg>
              </a>
              <a class="check_similar" title="Check all like this">✔</a>
            </div>
          {% endfor %}
          </td>
          <td>{{ dialect.get_community_display }}</td>
          <td>{{ dialect.get_location_display }}</td>
          <td>
            {% if dialect_feature.id %}
            <a href="{% url 'dialects:dialect-feature' dialect.id dialect_feature.id %}">details</a>
            {% endif %}
            {% if user.is_staff %}
            <a href="{% url 'dialects:dialect-feature-edit' dialect.id feature.fullheading %}">{{dialect_feature.id|yesno:"edit,add"}}</a>
            {% endif %}
          </td>
        </tr>
      {% endwith %}
      {% empty %}
      <tr>
      <td style="padding: 4em 10em;">No results found</td>
      </tr>
      {% endfor %}
    </table>
    </form>

    {% if group_summary %}
    <div class="halfwidth">
    <h3>Summary of custom groups</h3>
    <table class="campl-table campl-table-condensed campl-table-striped">
      <tr>
        <th>Group</th>
        <th>Occurrences</th>
      </tr>
      {% for group_key, num in group_summary.items %}
      <tr>
        <td>{{group_key}}</td>
        <td class="ar">{{num}}</td>
      </tr>
      {% endfor %}
    </table>
    </div>
    {% endif %}

    <div class="halfwidth">
    <h3>Summary of full table</h3>
    <table class="campl-table campl-table-condensed campl-table-striped">
      <tr>
        <th>Entry</th>
        <th>Occurrences</th>
      </tr>
      {% for entry, num in frequency_summary %}
      <tr>
        <td>{{entry}}</td>
        <td class="ar">{{num}}</td>
      </tr>
      {% endfor %}
    </table>
    </div>

  </div>
  </div>

 {% if user.is_staff %}
  <div class='campl-column12'>
  <div class="campl-content-container">
      <div style="background-color: #fec9; padding: 6px;">
        Staff-only: <br>
        {% if with_without_unknown == 'with' %}
        <form action="" method="POST">
          {% csrf_token %}
          In above entries find
          <input name="find" value="{{search_term}}" {{search_term|yesno:"readonly,"}}>
          and replace with
          <input name="replace" value="{{replacement}}" {{search_term|yesno:"readonly,"}}>
          {% if search_term %}
            <input type="submit" class="button" name="confirm" value="Confirm">
            (this can't be undone)
          {% else %}
            <input type="submit" class="button" value="Apply">
          {% endif %}
        </form>
        {% endif %}
        {% if with_without_unknown == 'unknown' %}
          <button class="button" id="mark_without">Mark as does not have this feature</button>

          <select class="button" id="bulk_enter" style="height: initial; width: initial; font-family: monospace;">
            <option>-- Bulk add entries for selected --</option>
            <optgroup label="existing entries:">
            {% for entry in unique_entries %}
              <option value="{{entry}}">{{entry}}</option>
            {% endfor %}
            </optgroup>
              <option value="NEW_ENTRY">(type new entry)</option>
          </select>
        {% endif %}
      </div>
  </div>
  </div>
  {% endif %}

<style>
.dialect_filter_form {margin-bottom: -2.6em;}
.map_group {
  min-width: 1.5em;
  padding: 0.4em;
  background:white;
  border: 1px solid #aaa;
  border-radius:50%;
  text-align:center;
  font-size: 0.8em;
  display: none;
}
.map_group.visible {
  display: inline-block;
}

.check_similar {
  display: inline-block;
  position: relative;
  width: 1.3em; height: 1.3em;
  left: 1em;
  background-color: white;
  border: 1px #aaa;
  border-radius: 0.2em;
  margin-left: 1em;
  visibility: hidden;
  cursor: pointer;
  padding: 0.1em;
}
.check_similar:hover {
  text-decoration: none;
  background-color: var(--link);
}
*:hover > .filter,
*:hover > .check_similar {
  visibility: visible;
}

.halfwidth {
  display: inline-block;
  margin: 0;
  padding: 2em;
  width: 49%;
}

td.ar {text-align: right;}

</style>

<script>
$(function(){
  $('#feature_detail').on('click', '#add_to_group', function(){
    group_key = prompt('Which group key? ("0" to remove from group)');
    $('.row_select:checked').each(function(){
      $row = $(this).parents('tr').eq(0);
      $row.find('[name="group_key"]').val(group_key)
      $row.find('.map_group').html(group_key).addClass('visible')
      $(this).prop('checked', false )
    })
  });

  $('#mark_without').on('click', function(){
    $('#table_form').attr('action', '?mark_without=true').submit()
  })

  $('#bulk_enter').on('change', function(){
    entry_text = $(this).val();
    if(entry_text == 'NEW_ENTRY'){
      entry_text = prompt("Type a new feature entry for the seleted dialects");
    }
    if(entry_text){
      $('#table_form').attr('action', '?bulk_enter='+entry_text).submit();
    }
  })

  $('.check_similar').on('click', function(){
    entry_text = $(this).prevAll('.entry').text();
    is_checked = $(this).parents('tr').find('.row_select').prop('checked');
    check_all_matching(entry_text, is_checked)
  });

  function check_all_matching(text, undo=false){
    $('#table_form .entry').each(function(){
      if($(this).text() == text){
        $(this).parents('tr').find('.row_select').prop('checked', !undo);
      }
    })
  }


  // makes checkbox in header row control state of all in table
  $('.checkable-rows th input[type=checkbox]').click(function () {
    $(this).parents('form').find('td input[type=checkbox]').prop('checked', $(this).prop('checked')).trigger('checkable-rows:group-select');
  });

  // range selection for checkboxes within a form
  $('.checkable-rows tbody').on('click', 'input[type=checkbox]', function(e){
    $checkboxes   = $(this).parents('form').find('input[type=checkbox]')
    $old_checkbox = $checkboxes.filter('.last_checkbox_clicked').removeClass('last_checkbox_clicked')
    $new_checkbox = $(this).addClass('last_checkbox_clicked')
    if( e.shiftKey )
    {
      $checkboxes.each(function(){
        index     = $checkboxes.index($(this))
        old_index = $checkboxes.index($old_checkbox)
        new_index = $checkboxes.index($new_checkbox)
        if( index <= Math.max(old_index, new_index) && index >= Math.min(old_index, new_index))
        {
          $(this).prop('checked', $new_checkbox.prop('checked'))
          $old_checkbox.prop('checked', $new_checkbox.prop('checked'))
          $(this).trigger('checkable-rows:group-select')
        }
      })
    }
  })
})
</script>
{% endblock %}
