<div id="map"></div>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<script src="/static/js/borders.js"></script>
<script>

    var normalmap = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.{ext}', {
            attribution: '&copy; <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            minZoom: 6,
            maxZoom: 11,
            ext: 'png' });
    /*
    var printmap = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            minZoom: 6,
            maxZoom: 11 });
    */
    var cities = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_only_labels/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            minZoom: 6,
            maxZoom: 11,
            ext: 'png' });
    var cities_and_terrain = new L.LayerGroup([normalmap, cities])
    var baseLayers = {
        "Normal view": cities_and_terrain,
        //"Print view": printmap,
    };

    dataLayerOptions = {pointToLayer: function (feature, latlng) {
        class_list = feature.properties.community ? 'icon_base icon_' + feature.properties.community : 'default-icon';
        myIcon   = L.divIcon({iconSize: L.point(7, 7), className: class_list });
        myMarker = L.marker(latlng, { icon: myIcon });

        tooltip_options = {
            offset: L.point(0, -10),
            direction: 'top',
            className: 'map_tooltip',
            permanent: feature.properties.focus ? true : false,
        }
        myMarker.bindTooltip(feature.properties.name, tooltip_options);

        if(feature.properties.url){
            myMarker.on("click", function(){window.location = feature.properties.url});
        }
        return myMarker;
    }};
    var map     = L.map('map',{layers: [cities_and_terrain /*, printmap*/], center: [37, 45], zoom: 7, maxBoundsViscosity: 0.9});
    var borders = L.geoJSON(country_borders, {style: function(feature) { return { className: feature.properties.class }} }).addTo(map);
    var data    = L.geoJSON(null, dataLayerOptions).addTo(map);

    $.ajax({
        type: "GET",
        url: '/api/v1'+window.location.pathname,
        dataType: 'json',
        success: function (response) {
            data.addData(response);
            map.setMaxBounds(data.getBounds().pad(.1));
            }
    });

    /* {# may keep to re-introduce print mode #}
    var overlays = {
        "Data": data,
        "Country borders" : borders,
    };
    L.control.layers(baseLayers, overlays).addTo(map);
    */

    /* {# not sure this is doing anything, to remove if we don't implement label culling on zoom #}
    var show_label_zoom = 3; // zoom level threshold for showing/hiding labels
    var labels_visible = true;
    function show_hide_labels() {
        var cur_zoom = map.getZoom();
        if(labels_visible && cur_zoom < show_label_zoom) {
            labels_visible = false;
            map.eachLayer(function (layer) {
                layer.hideLabel && layer.hideLabel();
            });
        }
        else if(!labels_visible && cur_zoom >= show_label_zoom) {
            labels_visible = true;
            map.eachLayer(function (layer) {
                layer.showLabel && layer.showLabel();
            });
        }
    }
    map.on('zoomend', show_hide_labels);
    */
</script>
